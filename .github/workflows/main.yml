name: Nifty Trading Analyzer

on:
  schedule:
    # Runs every 27 minutes from 09:00 IST to 15:30 IST
    # (03:30 UTC to 10:00 UTC)
    # Times in IST: 09:00, 09:27, 09:54, 10:21, 10:48, 11:15, 11:42, 12:09, 12:36, 13:03, 13:30, 13:57, 14:24, 14:51, 15:18
    - cron: '30 3 * * 1-5'      # 09:00 IST
    - cron: '57 3 * * 1-5'      # 09:27 IST
    - cron: '24 4 * * 1-5'      # 09:54 IST
    - cron: '51 4 * * 1-5'      # 10:21 IST
    - cron: '18 5 * * 1-5'      # 10:48 IST
    - cron: '45 5 * * 1-5'      # 11:15 IST
    - cron: '12 6 * * 1-5'      # 11:42 IST
    - cron: '39 6 * * 1-5'      # 12:09 IST
    - cron: '6 7 * * 1-5'       # 12:36 IST
    - cron: '33 7 * * 1-5'      # 13:03 IST
    - cron: '0 8 * * 1-5'       # 13:30 IST
    - cron: '27 8 * * 1-5'      # 13:57 IST
    - cron: '54 8 * * 1-5'      # 14:24 IST
    - cron: '21 9 * * 1-5'      # 14:51 IST
    - cron: '48 9 * * 1-5'      # 15:18 IST
  
  workflow_dispatch:
  
  push:
    branches:
      - main
      - master

# Sets permissions for GitHub Pages deployment
permissions:
  contents: write
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  analyze:
    name: Run Nifty Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          
          # Install curl-cffi first (CRITICAL for NSE API)
          pip install curl-cffi
          
          # Install other dependencies
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy yfinance pytz pyyaml
          fi
          
          echo "âœ… Dependencies installed"
          pip list
      
      - name: Create config.yml
        run: |
          cat > config.yml << 'CONFIG_EOF'
          email:
            recipient: "${{ secrets.RECIPIENT_EMAIL }}"
            sender: "${{ secrets.SENDER_EMAIL }}"
            app_password: "${{ secrets.EMAIL_APP_PASSWORD }}"
            subject_prefix: "Nifty Trading Alert"
            send_on_failure: false
          
          technical:
            timeframe: "1h"
            period: "6mo"
            rsi_period: 14
            rsi_overbought: 70
            rsi_oversold: 30
            ema_short: 20
            ema_long: 50
            num_support_levels: 2
            num_resistance_levels: 2
            momentum_threshold_strong: 0.5
            momentum_threshold_moderate: 0.2
          
          option_chain:
            pcr_bullish: 1.0
            pcr_very_bullish: 1.2
            pcr_bearish: 1.0
            pcr_very_bearish: 0.8
            strike_range: 500
            min_oi: 100000
            top_strikes_count: 5
          
          recommendation:
            strong_buy_threshold: 3
            buy_threshold: 1
            sell_threshold: -1
            strong_sell_threshold: -3
            momentum_5h_weight: 2
            momentum_1h_weight: 1
          
          report:
            title: "NIFTY DAY TRADING ANALYSIS (1H)"
            save_local: true
            local_dir: "./reports"
            filename_format: "nifty_analysis_%Y%m%d_%H%M%S.html"
            colors:
              strong_buy:
